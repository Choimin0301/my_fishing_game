<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”¼ì…”ë§¨ íƒ€ì´ì¿¤ : ì»´í”Œë¦¬íŠ¸ ì—ë””ì…˜</title>
    <style>
        :root {
            --sky-day: #87CEEB; --sea-day: #1E90FF;
            --sky-night: #1a1a2e; --sea-night: #16213e;
        }
        body { font-family: 'Apple SD Gothic Neo', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; transition: 1s; background: #f0f0f0; user-select: none; }
        .day-mode { --sky: var(--sky-day); --sea: var(--sea-day); --panel-bg: white; --text: black; }
        .night-mode { --sky: var(--sky-night); --sea: var(--sea-night); --panel-bg: #252545; --text: #e0e0e0; background: #0f0f1b; }

        /* ê²Œì„ í™”ë©´ ë° íš¨ê³¼ */
        #game-window { 
            position: relative; width: 480px; height: 320px; 
            background: linear-gradient(to bottom, var(--sky) 50%, var(--sea) 50%); 
            border: 4px solid #333; border-radius: 20px; overflow: hidden; cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        #fisherman { position: absolute; top: 32%; left: 30px; font-size: 65px; z-index: 2; transition: 0.3s; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)); }
        #bobber { position: absolute; top: 55%; left: 240px; font-size: 25px; display: none; transition: top 0.2s; }
        #alert { position: absolute; top: 35%; left: 250px; font-size: 50px; display: none; animation: bounce 0.3s infinite alternate; text-shadow: 0 0 10px yellow; z-index: 5;}
        
        #gauge-box { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 300px; display: none; background: rgba(255,255,255,0.9); padding: 6px; border-radius: 15px; border: 3px solid #333; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #gauge-fill { height: 25px; width: 30%; background: linear-gradient(90deg, #ff4d4d, #f9cb28, #32CD32); border-radius: 10px; transition: width 0.1s linear; }
        #combo-text { position: absolute; top: 60px; right: 20px; font-size: 24px; font-weight: bold; color: #FFD700; text-shadow: 2px 2px 0 #000; opacity: 0; transition: 0.3s; transform: scale(0.5); }
        #combo-text.active { opacity: 1; transform: scale(1.2); }

        /* ê²°ê³¼ ì°½ íŒì—… (ì„±ê³µ) */
        #result-popup { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            width: 220px; background: rgba(255,255,255,0.98); border: 4px solid #FF7F50;
            border-radius: 20px; text-align: center; padding: 20px; z-index: 100; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #333; box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }
        #result-popup.show { transform: translate(-50%, -50%) scale(1); }

        /* ê²°ê³¼ ì°½ íŒì—… (ì‹¤íŒ¨) - ì¶”ê°€ëœ ë¶€ë¶„ */
        #result-popup.fail { border-color: #666; background: rgba(245, 245, 245, 0.98); }
        #result-popup.fail #pop-name { color: #555 !important; }
        #result-popup.fail #pop-price { color: #d9534f !important; font-weight: normal; }

        .container { width: 490px; margin-top: 15px; }
        .stats { background: var(--panel-bg); color: var(--text); padding: 12px; border-radius: 15px; display: flex; justify-content: space-around; font-weight: bold; border: 2px solid #ddd; margin-bottom: 10px; transition: 0.5s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        .grid-ui { display: grid; grid-template-columns: 180px 1fr; gap: 15px; }
        .panel { background: var(--panel-bg); color: var(--text); padding: 15px; border-radius: 15px; border: 2px solid #ddd; transition: 0.5s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .panel h3 { margin: 0 0 10px 0; font-size: 16px; border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        #collection-ui { 
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; 
            height: 240px; overflow-y: auto; padding-right: 5px;
        }
        #collection-ui::-webkit-scrollbar { width: 6px; }
        #collection-ui::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        .fish-card { 
            text-align: center; padding: 10px; border: 1px solid #eee; 
            border-radius: 10px; background: rgba(127, 127, 127, 0.1); position: relative;
        }
        .fish-card.unknown { opacity: 0.4; filter: grayscale(1); }
        .fish-card.rare { border: 2px solid #FFD700; background: rgba(255, 215, 0, 0.1); }
        .fish-card .icon { font-size: 28px; display: block; margin-bottom: 2px; }
        .fish-card .name { font-size: 12px; font-weight: bold; margin-top: 4px; display: block; }
        
        .info-icons { font-size: 10px; margin-top: 5px; color: #888; display: flex; flex-direction: column; gap: 3px; align-items: center; }
        .info-tag { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; width: fit-content; }

        .btn-main { width: 100%; padding: 15px; font-size: 20px; border-radius: 15px; margin-bottom: 10px; border: none; background: #FF7F50; color: white; box-shadow: 0 5px #d45d31; cursor: pointer; font-weight: bold; transition: 0.1s; }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 1px #d45d31; }
        .btn-main:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; transform: none; }
        
        .upgrade-btn { width:100%; margin-top:5px; cursor:pointer; background:#FF7F50; color:white; border:none; padding:8px; border-radius:8px; font-weight: bold; transition: 0.2s; }
        .upgrade-btn:hover { background: #ff6b3d; }
        .upgrade-btn:disabled { background: #555 !important; cursor: default; }

        /* í´ë¦­ íŒŒí‹°í´ íš¨ê³¼ */
        .click-effect {
            position: absolute; pointer-events: none; animation: fadeUp 0.6s ease-out forwards;
            font-weight: bold; color: white; text-shadow: 0 0 3px black; font-size: 16px;
        }
        @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-30px); } }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-15px); } }
    </style>
</head>
<body class="day-mode">

    <div id="game-window" onclick="onScreenClick(event)">
        <div id="gauge-box"><div id="gauge-fill"></div></div>
        <div id="fisherman">ğŸ£</div>
        <div id="bobber">ğŸ”´</div>
        <div id="alert">â—</div>
        <div id="combo-text">COMBO x<span id="combo-val">0</span></div>
        
        <div id="result-popup">
            <div id="pop-title" style="font-size: 12px; color: #666;">ì„±ê³µ!</div>
            <div id="pop-icon" style="font-size: 60px; margin: 10px 0;">ğŸŸ</div>
            <div id="pop-name" style="font-size: 20px; font-weight: bold; color: #FF7F50;">ë©¸ì¹˜</div>
            <div id="pop-price" style="font-size: 16px; margin-bottom: 10px; font-weight:bold;">+10 G</div>
            <div id="pop-info" style="font-size: 11px; color: #888; border-top: 1px solid #eee; padding-top: 8px;">ğŸ“ì•ë°”ë‹¤ | â˜€ï¸ë‚®</div>
        </div>

        <div id="map-name" style="position:absolute; bottom:10px; right:20px; font-weight:bold; background:rgba(0,0,0,0.6); color:white; padding:5px 12px; border-radius:15px; font-size:12px;">í˜„ì¬: ì•ë°”ë‹¤</div>
    </div>

    <div class="container">
        <div class="stats">
            <span>ğŸ’° <span id="gold">0</span> G</span>
            <span>ğŸ’ª íŒŒì›Œ <span id="power-val">20</span></span>
            <span><span id="time-icon">â˜€ï¸</span> <span id="time-text">ë‚®</span></span>
        </div>

        <button id="start-btn" class="btn-main" onclick="startFishing()">ë‚šì‹œ ë˜ì§€ê¸°!</button>

        <div class="grid-ui">
            <div class="panel">
                <h3>ğŸ›’ ìƒì  & ì´ë™</h3>
                
                <div style="font-size: 12px; margin-bottom:15px; border-bottom: 1px dashed #ccc; padding-bottom: 15px;">
                    <div style="margin-bottom: 5px;">ğŸ£ ì¥ë¹„ ê°•í™” (+5)</div>
                    <button class="upgrade-btn" onclick="buyUpgrade('power')">150 G</button>
                </div>

                <div style="font-size: 12px;">
                    <div style="margin-bottom: 5px;">âœˆï¸ ë‚šì‹œí„° ì´ë™</div>
                    <div id="map-btn-container" style="display:flex; flex-direction:column; gap:6px;">
                        </div>
                </div>

                <div style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px; text-align: right;">
                    <button onclick="resetData()" style="background:#666; font-size:10px; color:white; border:none; border-radius:4px; padding:4px 8px; cursor: pointer;">ë°ì´í„° ì´ˆê¸°í™”</button>
                </div>
            </div>

            <div class="panel">
                <h3>ğŸ“– ì–´ë¥˜ ë„ê° <small>(<span id="collect-count">0</span>/20)</small></h3>
                <div id="collection-ui"></div>
            </div>
        </div>
    </div>

    <script>
        // --- ê²Œì„ ë°ì´í„° ë° ë³€ìˆ˜ ---
        let gold = 0, power = 20, gameState = "IDLE", currentMap = 0;
        let isNight = false, reelProgress = 30;
        let combo = 0;

        const maps = [
            { name: "ì•ë°”ë‹¤", cost: 0, unlocked: true },
            { name: "í•´ìš´ëŒ€", cost: 500, unlocked: false }
        ];

        // weight: ë‚®ì„ìˆ˜ë¡ ì¡ê¸° í˜ë“  í¬ê·€ ë¬¼ê³ ê¸°
        const fishes = [
            // ì•ë°”ë‹¤ (Map 0)
            { name: "ë©¸ì¹˜", price: 10, weight: 100, icon: "ğŸŸ", maps: [0], time: 0 },
            { name: "ë‚˜ë¹„ê³ ê¸°", price: 30, weight: 80, icon: "ğŸ ", maps: [0], time: 1 },
            { name: "ê½ƒê²Œ", price: 40, weight: 70, icon: "ğŸ¦€", maps: [0], time: 0 },
            { name: "ë³µì–´", price: 70, weight: 50, icon: "ğŸ¡", maps: [0], time: 1 },
            { name: "ì „ì–´", price: 35, weight: 60, icon: "ğŸŸ", maps: [0], time: 1 },
            { name: "ë„™ì¹˜", price: 110, weight: 40, icon: "ğŸ ", maps: [0, 1], time: 0 },
            
            // ê³µí†µ í¬ê·€
            { name: "ì˜¤ì§•ì–´", price: 50, weight: 60, icon: "ğŸ¦‘", maps: [0, 1], time: 2 },
            { name: "í•´íŒŒë¦¬", price: 80, weight: 45, icon: "ğŸ‘¾", maps: [0, 1], time: 2 },
            { name: "í™©ê¸ˆì‰ì–´", price: 3000, weight: 5, icon: "âœ¨", maps: [0, 1], time: 0 },

            // í•´ìš´ëŒ€ (Map 1)
            { name: "ê³ ë“±ì–´", price: 90, weight: 80, icon: "ğŸŸ", maps: [1], time: 1 },
            { name: "ê°ˆì¹˜", price: 130, weight: 70, icon: "ğŸ—¡ï¸", maps: [1], time: 2 },
            { name: "ì•„ê·€", price: 150, weight: 50, icon: "ğŸ®", maps: [1], time: 2 },
            { name: "ë¬¸ì–´", price: 200, weight: 40, icon: "ğŸ™", maps: [1], time: 0 },
            { name: "ê°€ì˜¤ë¦¬", price: 350, weight: 30, icon: "ğŸª", maps: [1], time: 0 },
            { name: "í•´ë§ˆ", price: 400, weight: 25, icon: "ğŸ´", maps: [1], time: 1 },
            { name: "ì°¸ë”", price: 250, weight: 35, icon: "ğŸŸ", maps: [1], time: 1 },
            { name: "ì‹¬í•´ì¥ì–´", price: 600, weight: 20, icon: "ğŸ", maps: [1], time: 2 },
            { name: "ë°”ë‹¤ê±°ë¶", price: 1000, weight: 15, icon: "ğŸ¢", maps: [1], time: 0 },
            { name: "ìƒì–´", price: 1500, weight: 10, icon: "ğŸ¦ˆ", maps: [1], time: 2 },
            { name: "ê³ ë˜", price: 7000, weight: 2, icon: "ğŸ³", maps: [1], time: 1 }
        ];

        // ì´ˆê¸°í™”
        fishes.forEach((f, i) => { f.id = i; f.count = 0; });
        loadGame();

        // --- ì‹œê°„ ì‹œìŠ¤í…œ ---
        setInterval(() => {
            isNight = !isNight;
            const body = document.body;
            body.className = isNight ? "night-mode" : "day-mode";
            document.getElementById('time-text').innerText = isNight ? "ë°¤" : "ë‚®";
            document.getElementById('time-icon').innerText = isNight ? "ğŸŒ™" : "â˜€ï¸";
        }, 15000); // 15ì´ˆë§ˆë‹¤ ë‚®ë°¤ ë³€ê²½

        // --- ë Œë”ë§ ---
        function renderCollection() {
            const ui = document.getElementById('collection-ui');
            ui.innerHTML = '';
            fishes.forEach(f => {
                const isFound = f.count > 0;
                const isRare = f.weight <= 20; 
                const timeStr = f.time === 0 ? "ì¢…ì¼" : (f.time === 1 ? "ë‚®" : "ë°¤");
                const mapStr = f.maps.map(mIdx => maps[mIdx].name).join('/');
                
                ui.innerHTML += `
                    <div class="fish-card ${isFound ? '' : 'unknown'} ${isFound && isRare ? 'rare' : ''}">
                        <span class="icon">${isFound ? f.icon : 'â“'}</span>
                        <span class="name">${isFound ? f.name : '???'}</span>
                        <div class="info-icons">
                            <span class="info-tag">${mapStr}</span>
                            <span class="info-tag">${timeStr}</span>
                            <span class="info-tag">${f.count}ë§ˆë¦¬</span>
                        </div>
                    </div>`;
            });
            document.getElementById('collect-count').innerText = fishes.filter(f => f.count > 0).length;
        }

        // --- ë©”ì¸ ê²Œì„ ë¡œì§ ---
        function startFishing() {
            if (gameState !== "IDLE") return;
            gameState = "WAITING";
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').innerText = "ì°Œë¥¼ ì£¼ì‹œí•˜ì„¸ìš”...";
            document.getElementById('bobber').style.display = "block";
            document.getElementById('alert').style.display = "none";
            document.getElementById('result-popup').classList.remove('show');
            document.getElementById('result-popup').classList.remove('fail');
            
            // ëœë¤ ì…ì§ˆ (1~3ì´ˆ)
            setTimeout(() => {
                if(gameState === "WAITING") {
                    gameState = "BITE";
                    document.getElementById('alert').style.display = "block";
                    document.getElementById('bobber').style.top = "60%";
                    playSound('bite');
                    
                    // ì…ì§ˆ ë°˜ì‘ ì‹œê°„ ì²´í¬ (1ì´ˆ ë‚´ ë¯¸í´ë¦­ ì‹œ ë†“ì¹¨)
                    setTimeout(() => { 
                        if(gameState === "BITE") finish('miss'); 
                    }, 1000);
                }
            }, 1000 + Math.random() * 2000);
        }

        function onScreenClick(e) {
            if (gameState === "BITE") {
                // ë‚šì‹œ ì‹œì‘
                gameState = "REELING";
                document.getElementById('alert').style.display = "none";
                document.getElementById('gauge-box').style.display = "block";
                document.getElementById('start-btn').innerText = "í´ë¦­í•´ì„œ ë‹¹ê²¨!!";
                reelProgress = 30; 
                startReelingLogic();
            } else if (gameState === "REELING") {
                // [ìš”ì²­ ë°˜ì˜] ë‚´ë¶€ì ìœ¼ë¡œëŠ” ì ˆë°˜ë§Œ ì ìš©í•´ ë‚œì´ë„ ìœ ì§€
                reelProgress += power * 0.5; 
                if(reelProgress > 100) reelProgress = 100;
                
                // [ìš”ì²­ ë°˜ì˜] ì‹œê°ì ìœ¼ë¡œëŠ” ì „ì²´ íŒŒì›Œ ë°ë¯¸ì§€ë¥¼ ë„ì›€
                createClickParticle(e.clientX, e.clientY, "+" + power); 
                
                if(reelProgress >= 100) finish(true);
                updateGauge();
            }
        }

        function startReelingLogic() {
            let loop = setInterval(() => {
                if(gameState !== "REELING") { clearInterval(loop); return; }
                
                // ë§µë³„ ë‚œì´ë„ ì ìš©
                const dropRate = currentMap === 0 ? 1.5 : 2.5; 
                reelProgress -= dropRate;
                updateGauge();

                if(reelProgress <= 0) finish('fail'); // ê²Œì´ì§€ ë°”ë‹¥ -> ì‹¤íŒ¨
            }, 30);
        }

        function updateGauge() {
            const fill = document.getElementById('gauge-fill');
            fill.style.width = reelProgress + "%";
            if(reelProgress < 30) fill.style.background = "red";
            else if(reelProgress > 70) fill.style.background = "#32CD32";
            else fill.style.background = "orange";
        }

        // ê²°ê³¼ ì²˜ë¦¬ (ì„±ê³µ, ë†“ì¹¨, ëŠì–´ì§)
        function finish(resultType) {
            gameState = "IDLE";
            document.getElementById('gauge-box').style.display = "none";
            document.getElementById('bobber').style.display = "none";
            document.getElementById('bobber').style.top = "55%";
            document.getElementById('start-btn').disabled = false;
            document.getElementById('start-btn').innerText = "ë‚šì‹œ ë˜ì§€ê¸°!";

            if (resultType === true) {
                // ì„±ê³µ
                handleSuccess();
            } else if (resultType === 'miss') {
                // ì…ì§ˆ ë†“ì¹¨
                combo = 0; showCombo();
                showFailPopup("ë†“ì³¤ë‹¤!", "ë°˜ì‘ì´ ë„ˆë¬´ ëŠë¦½ë‹ˆë‹¤!\nëŠë‚Œí‘œê°€ ëœ¨ìë§ˆì í´ë¦­í•˜ì„¸ìš”!");
            } else if (resultType === 'fail') {
                // ê²Œì´ì§€ ë¶€ì¡± (í˜ê²¨ë£¨ê¸° íŒ¨ë°°)
                combo = 0; showCombo();
                showFailPopup("ì¤„ì´ ëŠì–´ì§...", "ê´‘í´í•´ì„œ ê²Œì´ì§€ë¥¼ ìœ ì§€í•˜ì„¸ìš”!\n(íŒŒì›Œ ê°•í™” í•„ìš”)");
            } else {
                combo = 0; showCombo();
            }
            
            saveGame();
            updateUI();
            renderCollection();
        }

        function handleSuccess() {
            combo++;
            showCombo();

            const currentTimeType = isNight ? 2 : 1;
            let available = fishes.filter(f => f.maps.includes(currentMap) && (f.time === 0 || f.time === currentTimeType));
            if(available.length === 0) available = fishes.filter(f => f.maps.includes(currentMap));

            // ê°€ì¤‘ì¹˜ ëœë¤ ë¡œì§
            const totalWeight = available.reduce((acc, f) => acc + f.weight, 0);
            let randomNum = Math.random() * totalWeight;
            let caughtFish = available[0];

            for (let f of available) {
                if (randomNum < f.weight) { caughtFish = f; break; }
                randomNum -= f.weight;
            }
            
            // ë³´ìƒ ê³„ì‚°
            const comboBonus = Math.floor(caughtFish.price * (combo - 1) * 0.1);
            const finalPrice = caughtFish.price + comboBonus;
            
            gold += finalPrice;
            caughtFish.count++;
            
            // íŒì—… ë° íš¨ê³¼
            showPopup(caughtFish, finalPrice, combo > 1);
            const gw = document.getElementById('game-window');
            gw.classList.add('shake');
            setTimeout(()=> gw.classList.remove('shake'), 500);
        }

        // --- UI ë° íŒì—… ---
        function showPopup(fish, finalPrice, isCombo) {
            const popup = document.getElementById('result-popup');
            const timeStr = fish.time === 0 ? "ì¢…ì¼" : (fish.time === 1 ? "â˜€ï¸ë‚®" : "ğŸŒ™ë°¤");
            const mapStr = fish.maps.map(mIdx => maps[mIdx].name).join('/');
            
            document.getElementById('pop-icon').innerText = fish.icon;
            document.getElementById('pop-name').innerText = fish.name;
            document.getElementById('pop-price').innerHTML = `+${finalPrice} G ${isCombo ? '<span style="font-size:10px; color:red;">(ì½¤ë³´!)</span>' : ''}`;
            document.getElementById('pop-info').innerText = `${mapStr} | ${timeStr}`;
            
            popup.classList.add('show');
            setTimeout(() => { popup.classList.remove('show'); }, 2000);
        }

        function showFailPopup(title, msg) {
            const popup = document.getElementById('result-popup');
            popup.classList.add('fail');
            document.getElementById('pop-title').innerText = "ì‹¤íŒ¨";
            document.getElementById('pop-icon').innerText = "ğŸ’¨";
            document.getElementById('pop-name').innerText = title;
            document.getElementById('pop-price').innerHTML = `<span style="font-size:12px; color:#d9534f;">${msg.replace(/\n/g, '<br>')}</span>`;
            document.getElementById('pop-info').innerText = "ë‹¤ì‹œ ë„ì „í•˜ì„¸ìš”!";
            popup.classList.add('show');
            setTimeout(() => { popup.classList.remove('show'); }, 2000);
        }

        function showCombo() {
            const comboText = document.getElementById('combo-text');
            const comboVal = document.getElementById('combo-val');
            if(combo > 1) {
                comboVal.innerText = combo;
                comboText.classList.add('active');
            } else {
                comboText.classList.remove('active');
            }
        }

        function createClickParticle(x, y, text) {
            const el = document.createElement('div');
            el.className = 'click-effect';
            el.innerText = text;
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 600);
        }

        // --- ìƒì  ê¸°ëŠ¥ ---
        function buyUpgrade(type) {
            if (gold >= 150) { 
                gold -= 150; 
                power += 5; 
                saveGame();
                updateUI(); 
                alert("ê°•í™” ì„±ê³µ! íŒŒì›Œê°€ ì¦ê°€í–ˆìŠµë‹ˆë‹¤.");
            } else { alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); }
        }

        // [ìˆ˜ì •ëœ ë§µ ì´ë™ ë° UI ê°±ì‹  ë¡œì§]
        function unlockMap(id) {
            if (currentMap === id) return;

            if (!maps[id].unlocked) {
                if (gold >= maps[id].cost) {
                    gold -= maps[id].cost;
                    maps[id].unlocked = true;
                    alert(`ğŸ‰ [${maps[id].name}] ë‚šì‹œí„°ê°€ í•´ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    alert("ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!");
                    return;
                }
            }

            currentMap = id;
            document.getElementById('map-name').innerText = "í˜„ì¬: " + maps[id].name;
            combo = 0; showCombo();
            updateUI(); 
            saveGame();
            showFailPopup("ì´ë™ ì™„ë£Œ!", `${maps[id].name}ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.`);
        }

        function updateUI() {
            document.getElementById('gold').innerText = gold.toLocaleString();
            document.getElementById('power-val').innerText = power;

            // ë§µ ì´ë™ ë²„íŠ¼ ë¦¬ìŠ¤íŠ¸ ë™ì  ìƒì„±
            const mapContainer = document.getElementById('map-btn-container');
            mapContainer.innerHTML = "";

            maps.forEach((m, idx) => {
                const btn = document.createElement('button');
                btn.className = "upgrade-btn";
                btn.style.marginTop = "0";

                if (currentMap === idx) {
                    btn.innerText = `ğŸ“ ${m.name} (í˜„ì¬ ìœ„ì¹˜)`;
                    btn.disabled = true;
                } else {
                    if (m.unlocked) {
                        btn.innerText = `âœˆï¸ ${m.name} ì´ë™ (ë¬´ë£Œ)`;
                        btn.style.background = "#28a745";
                        btn.onclick = () => unlockMap(idx);
                    } else {
                        btn.innerText = `ğŸ”“ ${m.name} í•´ê¸ˆ (${m.cost} G)`;
                        btn.style.background = "#FF7F50";
                        btn.onclick = () => unlockMap(idx);
                    }
                }
                mapContainer.appendChild(btn);
            });
        }

        function playSound(type) { /* ì‚¬ìš´ë“œ ì—°ê²°ìš© */ }

        // --- ì €ì¥/ë¡œë“œ ---
        function saveGame() {
            const data = { gold, power, currentMap, mapsUnlocked: maps.map(m => m.unlocked), fishCounts: fishes.map(f => f.count) };
            localStorage.setItem('fishingTycoonSave_v3', JSON.stringify(data));
        }

        function loadGame() {
            const saved = localStorage.getItem('fishingTycoonSave_v3');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    gold = data.gold || 0;
                    power = data.power || 20;
                    currentMap = data.currentMap || 0;
                    if(data.mapsUnlocked) data.mapsUnlocked.forEach((ul, i) => { if(maps[i]) maps[i].unlocked = ul; });
                    if(data.fishCounts) data.fishCounts.forEach((cnt, i) => { if(fishes[i]) fishes[i].count = cnt; });
                    if(currentMap === 1) document.getElementById('map-name').innerText = "í˜„ì¬: " + maps[1].name;
                } catch(e) {}
            }
            updateUI();
        }

        function resetData() {
            if(confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ê³  ì²˜ìŒë¶€í„° ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('fishingTycoonSave_v3');
                location.reload();
            }
        }
    </script>
</body>
</html>